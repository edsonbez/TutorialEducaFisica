<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot de Educação Física</title>
    <!-- Inclui o Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .chat-container {
            max-width: 800px;
        }
        .message {
            max-width: 75%;
        }
        .message-user {
            background-color: #4f46e5;
            color: white;
            border-radius: 1.5rem 1.5rem 0.5rem 1.5rem;
        }
        .message-bot {
            background-color: #e2e8f0;
            color: #1a202c;
            border-radius: 1.5rem 1.5rem 1.5rem 0.5rem;
        }
        .gemini-gradient {
            background: linear-gradient(90deg, #ff6b6b, #4f46e5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 sm:p-6 md:p-8">
    <div class="chat-container w-full bg-white rounded-3xl shadow-xl flex flex-col h-[90vh] sm:h-[85vh] lg:h-[80vh]">
        <!-- Cabeçalho do Chat -->
        <header class="p-6 border-b border-gray-200 flex items-center justify-between rounded-t-3xl bg-white sticky top-0 z-10">
            <h1 class="text-2xl font-bold gemini-gradient">Assistente de Educação Física</h1>
        </header>

        <!-- Área de Mensagens -->
        <main id="chat-messages" class="flex-grow p-6 overflow-y-auto space-y-6">
            <div class="message message-bot p-4 rounded-3xl self-start drop-shadow-md">
                <p>Olá! Sou seu assistente de Educação Física. Como posso te ajudar hoje? Pergunte sobre exercícios, nutrição, ou qualquer coisa relacionada a bem-estar.</p>
            </div>
            <!-- As novas mensagens serão inseridas aqui via JavaScript -->
        </main>

        <!-- Área de Entrada de Mensagem -->
        <footer class="p-6 border-t border-gray-200 rounded-b-3xl bg-white sticky bottom-0 z-10">
            <form id="chat-form" class="flex items-center space-x-4">
                <input type="text" id="user-input" placeholder="Pergunte sobre exercícios, nutrição, etc..." class="flex-grow p-4 bg-gray-100 rounded-full border border-gray-300 focus:outline-none focus:border-indigo-500 transition-colors">
                <button type="submit" id="send-button" class="bg-indigo-600 text-white p-4 rounded-full shadow-lg hover:bg-indigo-700 transition-colors flex items-center justify-center disabled:bg-gray-400" aria-label="Enviar">
                    <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                    <div id="loading-spinner" class="hidden w-6 h-6 border-4 border-white border-solid border-t-transparent rounded-full animate-spin"></div>
                </button>
            </form>
        </footer>
    </div>

    <script>
        // Configurações do chatbot
        const form = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatMessages = document.getElementById('chat-messages');
        const sendButton = document.getElementById('send-button');
        const sendIcon = document.getElementById('send-icon');
        const loadingSpinner = document.getElementById('loading-spinner');

        // Configuração da API. Deixe a chave como uma string vazia.
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // Função para adicionar uma mensagem ao chat
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'p-4', 'rounded-3xl', 'drop-shadow-md');
            messageDiv.classList.add(sender === 'user' ? 'message-user' : 'message-bot');
            messageDiv.classList.add(sender === 'user' ? 'self-end' : 'self-start');
            messageDiv.innerHTML = `<p>${text}</p>`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Função para simular o estado de "carregando"
        function setLoading(isLoading) {
            sendButton.disabled = isLoading;
            sendIcon.classList.toggle('hidden', isLoading);
            loadingSpinner.classList.toggle('hidden', !isLoading);
            userInput.disabled = isLoading;
        }

        // Função para lidar com o envio da mensagem
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (!message) return;

            // Adiciona a mensagem do usuário
            addMessage(message, 'user');
            userInput.value = '';
            setLoading(true);

            // Payload para a API do Gemini
            const payload = {
                contents: [{ parts: [{ text: message }] }],
                systemInstruction: {
                    parts: [{ text: "Você é um assistente de educação física amigável e informativo. Responda a perguntas sobre exercícios, nutrição, esportes e bem-estar, mantendo uma abordagem de incentivo e segurança." }]
                },
            };

            // Chamada à API com retry exponencial
            const maxRetries = 5;
            let retries = 0;
            let responseText = "Desculpe, não consegui obter uma resposta. Por favor, tente novamente mais tarde.";

            while (retries < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result?.candidates?.[0];
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        responseText = candidate.content.parts[0].text;
                        break;
                    } else {
                        throw new Error("Resposta da API em formato inesperado.");
                    }
                } catch (error) {
                    retries++;
                    await new Promise(res => setTimeout(res, Math.pow(2, retries) * 1000));
                }
            }

            // Adiciona a resposta do bot
            addMessage(responseText, 'bot');
            setLoading(false);
        });
    </script>
</body>
</html>