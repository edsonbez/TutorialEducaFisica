<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistente de Estudos - Educação Física</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        
        // Define as variáveis globais do Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Inicializa o Firebase e o Firestore
        let app;
        let db;
        let auth;
        let userId;

        setLogLevel('Debug');

        // Inicializa o aplicativo e o banco de dados
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Falha ao inicializar o Firebase:", error);
        }

        const chatHistory = []; // Mantém o histórico da conversa

        // Função para autenticar o usuário
        async function authenticate() {
            try {
                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Erro de autenticação:", error);
            }
        }

        // Observador de estado de autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('user-id-display').innerText = `ID do Usuário: ${userId}`;
                console.log(`Usuário autenticado com sucesso. ID: ${userId}`);
            } else {
                console.log("Usuário não autenticado.");
                userId = null;
            }
        });

        // Chamada inicial para autenticar
        authenticate();

        document.addEventListener('DOMContentLoaded', () => {
            const chatContainer = document.getElementById('chat-container');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessage = document.getElementById('error-message');
            const notesList = document.getElementById('notes-list');
            const noteInput = document.getElementById('note-input');
            const saveNoteButton = document.getElementById('save-note-button');

            // API endpoint and key
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            // System instructions for the LLM
            const systemPrompt = "Você é um especialista em Educação Física e um tutor acadêmico. Seu objetivo é auxiliar um estudante de graduação a aprofundar seu conhecimento, se preparar para avaliações e desenvolver habilidades de escrita acadêmica. Você deve ser encorajador, didático e adaptar-se ao estilo de aprendizado do usuário. Forneça respostas detalhadas e úteis, mantendo a persona de tutor.";

            // Function to add messages to the chat interface
            function addMessage(text, sender) {
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

                const messageBubble = document.createElement('div');
                messageBubble.className = `chat-bubble ${sender === 'user' ? 'user' : 'ai'} shadow-sm`;
                messageBubble.innerText = text;

                messageWrapper.appendChild(messageBubble);
                chatContainer.appendChild(messageWrapper);
                chatContainer.scrollTop = chatContainer.scrollHeight; // Auto-scroll to the bottom
                chatHistory.push({ role: sender === 'user' ? 'user' : 'model', parts: [{ text: text }] });
            }

            // Function to handle the chat interaction
            async function sendMessage() {
                const userMessage = messageInput.value.trim();
                if (!userMessage) return;

                // Display user message
                addMessage(userMessage, 'user');
                messageInput.value = '';

                // Show loading indicator and disable input
                loadingIndicator.style.display = 'flex';
                sendButton.disabled = true;

                // Construct the payload for the API
                const payload = {
                    contents: chatHistory,
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                // Exponential backoff for API calls
                let retryCount = 0;
                const maxRetries = 3;
                let delay = 1000;

                while (retryCount < maxRetries) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();
                        const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (aiResponse) {
                            addMessage(aiResponse, 'ai');
                            errorMessage.style.display = 'none';
                            break; // Exit the loop on success
                        } else {
                            throw new Error("Resposta da IA vazia ou inesperada.");
                        }
                    } catch (error) {
                        retryCount++;
                        if (retryCount >= maxRetries) {
                            console.error("Erro na comunicação com a API após várias tentativas:", error);
                            errorMessage.style.display = 'block';
                            addMessage("Desculpe, não consegui me conectar. Por favor, verifique sua conexão ou tente novamente mais tarde.", "ai");
                            break; // Exit the loop on final failure
                        }
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Double the delay for the next retry
                    }
                }

                // Hide loading indicator and enable input
                loadingIndicator.style.display = 'none';
                sendButton.disabled = false;
            }

            // Firestore logic for saving and displaying notes
            saveNoteButton.addEventListener('click', async () => {
                const noteText = noteInput.value.trim();
                if (!noteText || !userId) return;

                const notesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/notes`);
                await addDoc(notesCollectionRef, { text: noteText, timestamp: Date.now() });
                noteInput.value = '';
            });

            // Firestore listener to get notes in real-time
            const notesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/notes`);
            onSnapshot(notesCollectionRef, (snapshot) => {
                notesList.innerHTML = '';
                snapshot.forEach((doc) => {
                    const note = doc.data();
                    const noteItem = document.createElement('li');
                    noteItem.className = "p-2 bg-gray-200 rounded-md shadow-sm";
                    noteItem.innerText = note.text;
                    notesList.appendChild(noteItem);
                });
            });

            // Event listeners for chat
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault(); // Prevents a new line
                    sendMessage();
                }
            });
        });
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .chat-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 20px;
            word-wrap: break-word;
        }
        .chat-bubble.user {
            background-color: #3b82f6;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-bubble.ai {
            background-color: #e5e7eb;
            color: #374151;
            border-bottom-left-radius: 4px;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white rounded-3xl shadow-lg flex flex-col md:flex-row w-full max-w-6xl h-[90vh] overflow-hidden">

        <!-- Sidebar for Notes -->
        <aside class="p-6 bg-gray-50 border-r border-gray-200 md:w-1/3 flex flex-col rounded-l-3xl">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Minhas Anotações</h2>
            <div id="user-id-display" class="text-xs text-gray-500 mb-4 break-all">Aguardando autenticação...</div>
            <ul id="notes-list" class="flex-grow space-y-2 overflow-y-auto pr-2">
                <!-- Notes will be loaded here -->
            </ul>
            <div class="mt-4 flex flex-col space-y-2">
                <textarea id="note-input" class="w-full p-2 rounded-lg border border-gray-300 resize-none" rows="2" placeholder="Adicionar uma nova anotação..."></textarea>
                <button id="save-note-button" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition-colors">Salvar Anotação</button>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="flex-grow flex flex-col w-full md:w-2/3">
            <!-- Header -->
            <header class="bg-blue-600 text-white p-6 rounded-tr-3xl shadow-md">
                <h1 class="text-2xl md:text-3xl font-bold">Assistente de Estudos</h1>
                <p class="text-sm md:text-base opacity-90 mt-1">Seu tutor especializado em Educação Física.</p>
            </header>

            <!-- Chat Container -->
            <div id="chat-container" class="flex-grow p-6 overflow-y-auto space-y-4">
                <!-- Initial Message from AI -->
                <div class="flex justify-start">
                    <div class="chat-bubble ai shadow-sm">
                        Olá! Sou seu assistente de estudos em Educação Física. Como posso te ajudar hoje?
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <footer class="p-6 bg-gray-50 border-t border-gray-200 flex items-center space-x-4">
                <textarea id="message-input" class="flex-grow p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors resize-none" placeholder="Digite sua pergunta ou comando..." rows="1"></textarea>
                <button id="send-button" class="bg-blue-600 text-white p-3 rounded-xl shadow-md hover:bg-blue-700 transition-colors font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Enviar
                </button>
            </footer>
        </main>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden absolute top-0 left-0 w-full h-full bg-black bg-opacity-30 items-center justify-center">
            <div class="loading-spinner"></div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden absolute bottom-24 p-4 left-1/2 -translate-x-1/2 bg-red-500 text-white rounded-xl shadow-lg transition-opacity duration-300">
            Ocorreu um erro ao processar sua solicitação. Por favor, tente novamente.
        </div>
    </div>
</body>
</html>
