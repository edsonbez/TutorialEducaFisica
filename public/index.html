<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerar Texto com Gemini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full text-center space-y-6">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Chamada da Função Gemini</h1>
        <p class="text-gray-500">
            Este é um aplicativo de exemplo que chama sua função do Firebase implantada.
        </p>
        
        <div id="status-container" class="space-y-4 text-left">
            <p id="user-status" class="text-gray-600 font-medium">Status de autenticação: <span class="text-blue-600">Carregando...</span></p>
            <p id="user-id" class="text-sm text-gray-400 break-all">ID de usuário: <span class="text-gray-500">Não disponível</span></p>
        </div>

        <button id="generate-btn" class="w-full py-3 px-6 rounded-xl bg-blue-600 text-white font-semibold shadow-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
            Gerar Texto
        </button>

        <div id="result-container" class="mt-8 pt-6 border-t border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-800 mb-2">Resultado da API</h2>
            <div id="result-text" class="bg-gray-100 p-4 rounded-lg text-gray-700 text-left whitespace-pre-wrap">
                O resultado aparecerá aqui...
            </div>
            <div id="loading-spinner" class="hidden mt-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let auth, functions;
        let userId;

        const userStatusEl = document.getElementById('user-status').querySelector('span');
        const userIdEl = document.getElementById('user-id').querySelector('span');
        const generateBtn = document.getElementById('generate-btn');
        const resultTextEl = document.getElementById('result-text');
        const loadingSpinner = document.getElementById('loading-spinner');

        // Main setup function on window load
        window.onload = async () => {
            if (!firebaseConfig) {
                console.error("Firebase config is missing. Please ensure it's provided.");
                userStatusEl.textContent = "Erro de configuração";
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                functions = getFunctions(app, 'us-central1'); // Replace with your function region

                // Authenticate the user with the custom token
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser.uid;
                userStatusEl.textContent = "Autenticado";
                userStatusEl.className = "text-green-600";
                userIdEl.textContent = userId;
                generateBtn.disabled = false;
            } catch (error) {
                console.error("Erro ao inicializar Firebase ou autenticar:", error);
                userStatusEl.textContent = "Falha na autenticação";
                userStatusEl.className = "text-red-600";
            }
        };

        generateBtn.addEventListener('click', async () => {
            generateBtn.disabled = true;
            resultTextEl.textContent = '';
            loadingSpinner.classList.remove('hidden');

            // Replace this URL with the actual URL from your terminal
            const firebaseFunctionUrl = 'https://us-central1-projeto-api-firebase.cloudfunctions.net/yourFunctionName'; // UPDATE THIS URL

            try {
                const response = await fetch(firebaseFunctionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt: 'Diga algo sobre a importância da inteligência artificial.' })
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const data = await response.json();
                resultTextEl.textContent = data.text || "Resposta vazia.";

            } catch (error) {
                console.error("Erro ao chamar a função:", error);
                resultTextEl.textContent = `Erro: ${error.message}`;
            } finally {
                loadingSpinner.classList.add('hidden');
                generateBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
